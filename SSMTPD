
-- NOTE this system is build on the KV storage system and requires its API to run
os.loadAPI("M3C/utils")
os.loadAPI("M3C/kvApi")

sensor = 

-- A Simple Implementation of the Stupid Simple Mail Transfer Protocol (SSMTP) Server Daemon
-- SSMTP is just a length(5) key value pair (a table in lua) containing the following key names in ALL CAPS 

-- TO: uname(Case Sensitive)
-- FROM: yourusername (Also Case Sensitive)
-- SUB: subjectgoeshere
-- MSG: (Message/Body/Data etc)
-- TS: (timestamp)
SSMTP = {TO = "", FROM = "", SUB = "", MSG = "", TS = 0}
-- Data is stored as {UUID,{TO,FROM,SUB,MSG,TS}, ...}}
-- where UUID is the KV key and TS is the key for the list of all emails attatched to a user. 

-- GET ALL MAIL
function getAllMail(playerUUID)
  return utils.getkvApiMsg(kvApi.clientGet(playerUUID))
end

-- GET (1) MAIL
function getMail(key)
  return kvApi.clientGet(key)
end

-- SEND MAIL
function updateMailbox(playerUUID, mail)
  return kvApi.clientStore(playerUUID, mail)
end

function login(user, pass)
    mailUsers = kvApi.clientGet("mailUsers")
    for x,y in pairs(mailUsers) do
        if x == user and y == pass then
          playerName = user
          return true
    end
    echo "I'm afraid that is incorrect Sir..."
    return false
end

function createUser(user, pass)
    mailUsers = kvApi.clientGet("mailUsers")
    mailUsers.insert(user, pass)
    kvApi.clientStore("mailUsers", mailUsers)
end

-- The Stupid Simple Mail Transfer Protocol was developed exclusivly in and for Computercraft 1.7

-- Detect sensor or fail out (aka require sensor)
sensor = utils.findAndWrapAll("sensor")
if sensor == nil then
    echo "no sensor attatched... authentication failed"
    exit(1)
else
    echo "Sensor Detected!"
    playerName = sensor.getPlayers()[1]
    playerUUID = sensor.getPlayers()[0]
end

-- Networking
if(utils.findAndWrapAll("modem") == nil)
  echo "no modem detected... can't connect to KV"
  exit(1)
else
    "Modem Detected!"
    kvApi.initializeWirelessModems()
end

-- MAIN LOOP
while true do
  echo "Greeting," ..   " how may I serve you today..."
  echo "(0) GET MAIL"
  echo "(1) SEND MAIL"
  input = io.read("*n")

  if(input == 0) then
    mailbox = getMail(playerUUID)
    totalMessages = (#mailbox)    
    echo "You have " .. totalMessages .. " Messages."
    echo "Which mail would you like to read" .. playerName
    messageNumber = io.read("*n")
    if (messageNumber > ) 
  elseif(input == 1) then
    TERM.clear()
    echo "TO: "
    to = io.read()
    echo "SUBJECT: "
    sub = io.read()
    echo "MESSAGE: "
    msg = io.read()
    ts = os.date() .. " " .. os.time()
    message = {TO:to, FROM:playerName, SUB:sub, MSG:msg, TS:ts}
    mailbox.insert(ts, message)
    updateMailbox(recipiantUUID, mailbox)
  else
    echo "Terribly Sorry Sir, I didn't quite get that."
    term.clear()
  end
end





