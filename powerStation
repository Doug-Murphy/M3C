os.loadAPI("M3C/utils")
os.loadAPI("M3C/kvApi")

local energyCellBaseName = "tile_thermalexpansion_cell_reinforced_name"
local energyCells = {}
local powerStats = {}

local totalDisplay = "Total"
local storeDisplay = "Stored"
local percentDisplay = "Available"

powerStats[totalDisplay] = 0
powerStats[storeDisplay] = 0

energyCells = utils.findAndWrapAll(energyCellBaseName)

kvApi.initializeWirelessModems()

while true do
  for index,energyCell in pairs(energyCells) do
    powerStats[totalDisplay] = powerStats[totalDisplay] + energyCell.getMaxEnergyStored() 
    powerStats[storeDisplay] = powerStats[storeDisplay] + energyCell.getEnergyStored()
  end

  powerStats[percentDisplay] = math.floor(tonumber(powerStats[storeDisplay])/tonumber(powerStats[totalDisplay]) * 100)
  powerStats[totalDisplay] = powerStats[totalDisplay]
  powerStats[storeDisplay] = powerStats[storeDisplay]
  
  kvApi.clientStore("powerStatus", textutils.serialize(powerStats))
  
  powerStats[totalDisplay] = 0
  powerStats[storeDisplay] = 0
  sleep(5)
end
