os.loadAPI("M3C/utils")

function format_int(n)
  return tostring(math.floor(n)):reverse():gsub("(%d%d%d)", "%1,"):gsub(",(%-?)$", "%1"):reverse()
end

local wlSend = peripheral.wrap("top")
local energyCellBaseName = "tile_thermalexpansion_cell_reinforced_name"
local energyCells = {}
local powerStats = {}
local serialData

local totalDisplay = "Total Power"
local storeDisplay = "Stored Power"
local percentDisplay = "Available"

powerStats[totalDisplay] = 0
powerStats[storeDisplay] = 0

energyCells = utils.findAndWrapAll(energyCellBaseName)

while true do
  for index,energyCell in pairs(energyCells) do
    powerStats[totalDisplay] = powerStats[totalDisplay] + energyCell.getMaxEnergyStored() 
    powerStats[storeDisplay] = powerStats[storeDisplay] + energyCell.getEnergyStored()
  end

  powerStats[percentDisplay] = math.floor(tonumber(powerStats[storeDisplay])/tonumber(powerStats[totalDisplay]) * 100)
  powerStats[totalDisplay] = format_int(powerStats[totalDisplay])
  powerStats[storeDisplay] = format_int(powerStats[storeDisplay])
    
  serialData = textutils.serialize(powerStats)
  wlSend.transmit(105,105,serialData)
  powerStats[totalDisplay] = 0
  powerStats[storeDisplay] = 0
  sleep(1)
end
