os.loadAPI("M3C/kvApi")
os.loadAPI("M3C/utils")

local dsus = utils.findAndWrapAll("deep_storage_unit")

kvApi.initializeWirelessModems()

while true do
  local contentsHash = {}
  for dsuKey, dsu in pairs(dsus) do
    dsuItems = dsu.getStoredItems()
    contentsHash[dsuItems.display_name] = dsuItems.qty
  end
  
  local contentsMsg = textutils.serialize(contentsHash)

  print("Message = "..contentsMsg)
  print("Sending to KV at " .. os.day() .. ": " .. os.time())
  kvApi.clientStore("reactorStatus", contentsMsg)

  sleep(30)
end
